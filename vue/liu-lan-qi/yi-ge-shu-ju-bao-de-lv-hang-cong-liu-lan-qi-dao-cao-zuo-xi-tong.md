---
title: 一个数据包的旅行(1)-从浏览器到操作系统
date: '2020-06-01T11:32:16.000Z'
category:
  - 计算机网络
tags:
  - 计算机网络
---

# 一个数据包的旅行——从浏览器到操作系统

## 前言

你好，这是我写的第一篇博客。

为什么写博客？这是我思考了很久的问题，你可以看到这个博客的第一篇博文就是《认真聊聊写博客这件事》，这是我从微信公众号里面引用过来的一片文章，里面提到了很多好处，其中一个点**不同于刷抖音、刷微博，写博客是一件高收益，长半衰期的事情**，让我觉得写博客是一件很酷的事情，所以就有了现在的这篇博文，总结的来说写博客对于我的意义在于

* 整理知识，让平时零散的碎片式的学习更有条理
* 锻炼语言表达能力和逻辑思维能力
* 帮助后人少踩坑
* 记录

因为疫情的原因一直没有开学，在这几个月的时间里，我读了《图解HTTP》、《图解密码技术》、《网络是怎么连接的》这几本技术相关的书籍，说来惭愧，放寒假前在学校图书馆借的好几本书关于前端的书都没有仔细的去翻阅，误打误撞的却看了几本计算机网络的书。

 ![&#x56FE;&#x89E3;HTTP](https://img-1251598303.cos.ap-guangzhou.myqcloud.com/s27283822-20200601131845095.jpg) ![&#x56FE;&#x89E3;&#x5BC6;&#x7801;&#x6280;&#x672F;](https://img-1251598303.cos.ap-guangzhou.myqcloud.com/s27844440-20200601131728925.jpg) ![&#x7F51;&#x7EDC;&#x662F;&#x600E;&#x4E48;&#x8FDE;&#x63A5;&#x7684;](https://img-1251598303.cos.ap-guangzhou.myqcloud.com/s29370067.jpg) &lt;/figure&gt;

粗略的看完这基本书后，对计算机网络也有了一个大概的认知，所以我想做一个系列的分享---一个数据包的旅行，它的另外一个名字可以叫做「从输入URL到浏览器显示页面这个过程发生了什么？」，这是一个特别热门的面试题，因为其涉及的面十分广阔，所以对受试者也能起到多方面的考察，虽然有很多大佬对其进行了详细的解释，像三元大佬的一系列文章[\(1.6w字\)浏览器灵魂之问，请问你能接得住几个？](https://juejin.im/post/5df5bcea6fb9a016091def69)、[\(建议收藏\)TCP协议灵魂之问，巩固你的网路底层基础](https://juejin.im/post/5e527c58e51d4526c654bf41)、[（建议精读）HTTP灵魂之问，巩固你的 HTTP 知识体系](https://juejin.im/post/5e76bd516fb9a07cce750746),动辄就是几万字的解说，虽然内容很优质，但是我还是有点不太喜欢这种，功利化、快餐式的学习。所以在看了这几本书之后，我准备写一写在我自己对于这个命题的回答，而这个回答的会分为几个阶段来描述一个数据包是如何分发、传送、识别、与解析的。大致是一下的几个阶段

### 内容结构

![image-20200602001434805](https://img-1251598303.cos.ap-guangzhou.myqcloud.com/image-20200602001434805.png)

## 正文

### 1.探索之旅从用户输入URL开始

当用户在地址栏中输入一个查询关键字时，浏览器会对URL进行解析，地址栏会判断输入的关键字是搜索内容，还是请求的 URL。

* 如果是搜索内容，地址栏会使用浏览器默认的搜索引擎，来合成新的带搜索关键字的 URL。
* 如果判断输入内容符合 URL 规则，比如输入的是 time.geekbang.org，那么地址栏会根据规则，把这段内容加上协议，合成为完整的 URL，如 [https://time.geekbang.org。](https://time.geekbang.org。)

当用户输入关键字并键入回车之后，这意味着当前页面即将要被替换成新的页面，不过在这个流程继续之前，浏览器还给了当前页面一次执行 beforeunload 事件的机会，beforeunload 事件允许页面在退出之前执行一些数据清理操作，还可以询问用户是否要离开当前页面，比如当前页面可能有未提交完成的表单等情况，因此用户可以通过 beforeunload 事件来取消导航，让浏览器不再执行任何后续工作。

### 2.发起URL 请求

接下来，便进入了页面资源请求过程。这时，浏览器进程会通过进程间通信（IPC）把 URL 请求发送至网络进程，网络进程接收到 URL 请求后，会在这里发起真正的 URL 请求流程。那具体流程是怎样的呢？

#### 生成HTTP请求消息

浏览器对URL进行解析后就确定了web服务器和文件名，接下来就是根据这些信息去生成HTTP请求。更多关于HTTP的知识，请阅读《图解HTTP》。

#### 查询缓存

首先，网络进程会查找本地缓存是否缓存了该资源。如果有缓存资源，那么直接返回资源给浏览器进程；如果在缓存中没有查找到资源，那么直接进入网络请求流程。

#### 向DNS服务器查询Web服务器的ip

> 互联网是基于TCP/IP来设计的，而TCP/IP网络是通过IP来确定通讯对象的，因此不知道IP地址就无法将消息发送给对方，这和我们打电话的时候必须要知道对方的电话号 码是一个道理。因此，在委托操作系统发送消息时，必须要先查询好对方 的 IP 地址。

要想向Web服务器发送请求，单单依靠域名可是不行的，在只有0和1的网络世界里，计算机可不认识什么域名不域名的，域名的出现是为了人们和服务器的ip地址对应上。

那DNS的查询过程是怎样的呢，请继续往下面看。

1. 首先浏览器会调用操作系统提供的Socket库中查询IP地址的API，只需要向下图这样，调用gethostbyname\(\)就能完成dns查询

> Socket 库是在加州大学伯克利分校开发的 UNIX 系操作系统 BSD 中开发的 C 语言库，互联网中所使用的大多数功能都是基于 Socket 库来开发的。因此， BSD 之外的其他操作系统以及 C 语言之外的其他编程语言也参照 Socket 库开 发了相应的网络库。可以说，Socket 库是网络开发中的一种标准库。

![](https://img-1251598303.cos.ap-guangzhou.myqcloud.com/20200601233342.png)

gethostbyname\(\)会根据DNS的规格，生成一条数据委托给操作系统内部的协议栈来执行，协议栈会执行发送消息的操作，然后通过网卡将消息发送给 DNS 服务器

> 为了加快域名的解析速度，DNS大部分场景采用的是UDP协议，此外DNS为了满足更高安全性的要求还出现了DNS over HTTPs\(DoH\)、 DNS JSON API、 DNS over TLS （DoT）等方式

当最近的DNS服务器没有查到服务器域名所对应的ip时，会继续向上一级DNS服务器查询，`这是一场全世界DNS服务器的大接力`，直到根域名服务器。查询到对应的ip地址之后，游览器会将ip地址缓存起来，当下一次发起查询时，会先去缓存中查找。

![](https://img-1251598303.cos.ap-guangzhou.myqcloud.com/20200602000047.png)

### 委托操作系统协议栈发送消息

知道了 IP 地址之后，就可以委托操作系统内部的协议栈向这个目标 IP地址，也就是我们要访问的 Web 服务器发送消息了。在此之前呢，我们首先要只要一个概念——套接字（ socket ）

![image-20200613151649558](https://img-1251598303.cos.ap-guangzhou.myqcloud.com/image-20200613151649558.png)

## 小结

一个数据包的第一站差不多到这里就结束了，现在我们来总结一下有哪些过程

1. 在地址栏输入关键字之后，浏览器会对内容进行解析，判断是需要搜索的内容还是请求的URL
2. 如果是搜索的内容则调用默认的搜索引擎，如果是URL则判断完整性，然后再进行纠错、补齐等操作
3. 然后就是发起HTTP请求了
   * 先查询本地有没有缓存
   * 然后再查询DNS（ UDP 协议 ）
   * 获取到 ip 后委托系统协议栈发送消息

至此，我们的数据包，到达了第一站也是始发站 **操作系统** ，下一站我们会前往局域网设备，也就是那些被我们丢在墙角吃灰的 `路由器`、`交换机`。为什么会需要这些设备，然后数据包在这些设备当中又是怎么传送的，请看下节分享《 一个数据包的旅行——从操作系统到局域网 》

